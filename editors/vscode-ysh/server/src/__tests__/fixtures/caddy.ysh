#!/usr/bin/env ysh
# =============================================================================
# TLS Activation
# Verifies DNS and enables reverse proxy for TLS termination
# =============================================================================

source-guard caddy.ysh || return 0

source lib/config.ysh

# -----------------------------------------------------------------------------
# Get Instance IP
# -----------------------------------------------------------------------------

proc get_instance_ip {
  gcloud compute instances describe $[CONFIG.instance_name] \
    --project=$[CONFIG.project] \
    --zone=$[CONFIG.zone] \
    --format='get(networkInterfaces[0].accessConfigs[0].natIP)'
}

# -----------------------------------------------------------------------------
# DNS Verification
# -----------------------------------------------------------------------------

proc verify_dns (expected_ip) {
  log_section "Verifying DNS Configuration"

  var current_ip = $(dig +short "$[CONFIG.domain]" A | head -1)

  if test -z "$current_ip" {
    log "WARNING: No DNS record found for $[CONFIG.domain]"
    log "Expected: $expected_ip"
    return 1
  }

  if test "$current_ip" != "$expected_ip" {
    log "WARNING: DNS mismatch!"
    log "  Current:  $current_ip"
    log "  Expected: $expected_ip"
    return 1
  }

  log "DNS correctly configured: $[CONFIG.domain] -> $expected_ip"
  return 0
}

proc wait_for_dns (expected_ip) {
  log_section "Waiting for DNS Propagation"
  log "Expected: $[CONFIG.domain] -> $expected_ip"

  var start_ts = $(date +%s)
  var timeout = CONFIG.dns_timeout_seconds
  var interval = CONFIG.dns_poll_interval

  while true {
    var now_ts = $(date +%s)
    var elapsed = now_ts - start_ts

    if (elapsed >= timeout) {
      log "ERROR: Timed out after $[timeout / 60] minutes waiting for DNS"
      return 1
    }

    var answers = $(dig +short A "$[CONFIG.domain]" 2>/dev/null || true)
    log "[$(date +%H:%M:%S)] A records: ${answers:-<none>}"

    # Check if expected IP is in the answers
    case $answers in
      (*$expected_ip*)
        log ""
        log "DNS propagation complete!"
        return 0
        ;;
    esac

    sleep $interval
  }
}

# -----------------------------------------------------------------------------
# Proxy Configuration
# -----------------------------------------------------------------------------

proc configure_proxy_remote {
  log_section "Configuring Proxy on Remote Instance"

  # First, ensure SSH is available and startup script has completed
  wait_for_ssh $[CONFIG.instance_name] $[CONFIG.project] $[CONFIG.zone]
  wait_for_startup_complete $[CONFIG.instance_name] $[CONFIG.project] $[CONFIG.zone]

  # Build config content
  var proxyconfig = "$[CONFIG.domain] {
    reverse_proxy 127.0.0.1:$[CONFIG.app_port]
    log {
        output file /var/log/proxy/access.log
    }
}"

  # Base64 encode for safe transmission
  var config_b64 = ''
  try {
    setvar config_b64 = $(echo "$proxyconfig" | base64 -w 0 2>/dev/null)
  }
  if (config_b64 === '') {
    # macOS fallback
    setvar config_b64 = $(echo "$proxyconfig" | base64)
  }

  log "Configuring proxy..."

  # Retry SSH command up to 3 times
  var ssh_attempt = 1
  var ssh_max = 3

  while (ssh_attempt <= ssh_max) {
    log "SSH configuration attempt $ssh_attempt/$ssh_max..."

    try {
      gcloud compute ssh "$[CONFIG.instance_name]" \
        --project="$[CONFIG.project]" \
        --zone="$[CONFIG.zone]" \
        --ssh-flag="-o StrictHostKeyChecking=no" \
        --command="sudo bash -lc 'set -e

# Create log directory
mkdir -p /var/log/proxy
chmod 755 /var/log/proxy

# Write config
echo $config_b64 | base64 -d | tee /etc/proxy/config >/dev/null

# Restart service
systemctl restart proxy

# Wait and check status
sleep 3
if systemctl is-active --quiet proxy; then
  echo \"Proxy started successfully!\"
else
  echo \"ERROR: Proxy failed to start\"
  exit 1
fi
'" > /dev/null

      log "Proxy configured and started"
      return 0
    }

    log "SSH command failed, retrying in 15 seconds..."
    sleep 15
    setvar ssh_attempt = ssh_attempt + 1
  }

  log "ERROR: Failed to configure proxy after $ssh_max attempts"
  return 1
}

# -----------------------------------------------------------------------------
# Main Enable Function
# -----------------------------------------------------------------------------

proc enable_tls {
  require_commands gcloud dig

  # Get instance IP
  var ip = $(get_instance_ip)
  log "Instance IP: $ip"

  # Wait for DNS
  wait_for_dns $ip

  # Configure proxy
  configure_proxy_remote

  log_section "TLS Activation Complete!"
  log ""
  log "Your instance is accessible at:"
  log "  https://$[CONFIG.domain]"
  log ""
  log "Test with:"
  log "  curl -v https://$[CONFIG.domain]/"
  log ""
}

# -----------------------------------------------------------------------------
# Run if executed directly
# -----------------------------------------------------------------------------

if is-main {
  enable_tls
}

